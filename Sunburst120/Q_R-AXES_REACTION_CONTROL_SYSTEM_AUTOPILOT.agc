### FILE="Main.annotation"
## Copyright:	Public domain.
## Filename:	Q_R-AXES_REACTION_CONTROL_SYSTEM_AUTOPILOT.agc
## Purpose:	A module for revision 0 of BURST120 (Sunburst). It 
##		is part of the source code for the Lunar Module's
##		(LM) Apollo Guidance Computer (AGC) for Apollo 5.
## Assembler:	yaYUL
## Contact:	Ron Burkey <info@sandroid.org>.
## Website:	www.ibiblio.org/apollo/index.html
## Mod history:	2016-09-30 RSB	Created draft version.
##		2016-10-30 RSB	Transcribed through page 537.

## Page 519
                BANK            17
# THE FOLLOWING T5RUPT ENTRY BEGINS THE PROGRAM WHICH CONTROLS THE Q,R-AXIS ACTION OF THE LEM USING THE RCS JETS.
# THE NOMINAL TIME BETWEEN THE Q,R-AXIS RUPTS IS 100 MS (UNLESS THE TRIM GIMBAL CONTROL SYSTEM IS USED, IN WHICH
# CASE THIS PROGRAM IS IDLE).

                EBANK=          DT
NULLFILT        2CADR           FILDUMMY

QRAXIS          CAF             MS20QR                  # RESET TIME IMMEDIATELY - DT = 20 MS
                TS              TIME5

                LXCH            BANKRUPT                # INTERRUPT LEAD IN (CONTINUED)
                EXTEND
                QXCH            QRUPT

# SET UP DUMMY KALMAN FILTER T5RUPT.  (THIS MAY BE RESET TO THE KALMAN FILTER INITIALIZATION PASS, IF THE TRIM
# GIMBAL CONTROL SYSTEM SHOULD BE USED.)

                EXTEND
                DCA             NULLFILT

# START CODING FOR MODULE 3 REMAKE, AUGUST 1967***START CODING FOR MODULE 3 REMAKE, AUGUST 1967*****************

		TCF		TRMCHECK		# ARE EXTRAORDINARY GTS ENTRIES NEEDED?
# **END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****************

# CALCULATE LEM BODY RATES FOR Q AND R AXES:

# THIS COMPUTATION IS VALID FOR BOTH ASCENT ADN DESCENT SINCE THE OFFSET ACCELERATION TERM IS INCLUDED ALWAYS,
# BUT HAS VALUE ZERO IN DESCENT, AND SINCE THE WEIGHTING FACTORS ARE IN ERASABLE AND DISTINCT.

# FIRST, CONSTRUCT Y AND Z CDU INCREMENTS:

BODYRATE        CAE             CDUY                    # 2:S COMPLEMENT MEASUREMENT SCALED AT PI
                TS              L                       # (SAVE FOR UPDATING OF OLDYFORQ)
                EXTEND                                  # FORM INCREMENT IN CDUY FOR LAST 100 MS
                MSU             OLDYFORQ                # (100 MS OLD CDUY SAVED FROM LAST PASS)
                LXCH            OLDYFORQ                # UPDATE OLDYFORQ WITH NEW CDUY VALUE
                TS		ITEMP1			# SAVE 1:S COMPLEMENT VALUE TEMPORARILY
                CAE             CDUZ                    # 2'S COMPLEMENT MEASUREMENT SCALED AT PI
                TS              L                       # (SAVE FOR UPDATING OF OLDZFORQ)
                EXTEND                                  # FORM INCREMENT IN CDUZ FOR LAST 100 MS
                MSU             OLDZFORQ                # (100 MS OLD CDUZ SAVED FROM LAST PASS)
                LXCH            OLDZFORQ                # UPDATE OLDZFORQ WITH NEW CDUZ VALUE
                TS	        ITEMP2                  # SAVE 1'S COMPLEMENT VALUE TEMPORARILY

## Page 520
# SECOND TRANSFORM CPU INCREMENTS TO BODY-ANGLE INCREMENTS:

                CAE             M31                     # MATRIX*VECTOR(WITH x COMPONENT ZERO)
                EXTEND
                MP              ITEMP1                  # M31 * ITEMP1 = M31 * DELTA CDUY
                TS              ITEMP4
                CAE             M32                     # M32 * ITEMP2 = M32 * DELTA CDUZ
                EXTEND
                MP              ITEMP2                  # DELTAR = M31*(DEL CDUY) + M32*(DEL CDUZ)
                DAS             ITEMP4                  # DOUBLE PRECISION R BODY ANGLE INCREMENT

		CAF		BIT9
		TS		Q
		EXTEND
		DCA		ITEMP4
		EXTEND
		DV		Q			# RESCALE TO PI/64 AND
		TS		ITEMP4			# STORE AS SINGLE PRECISION
                CAE             M21                     # MATRIX*VECTOR(WITH X COMPONENT ZERO)
                EXTEND                                  # CLOBBERS ITEMP2=DEL CDUZ, FOR EFFICIENCY
                MP              ITEMP1                  # M21 * ITEMP1 = M21 * DELTA CDUY
                XCH             ITEMP2                  # M22 * ITEMP2 = M22 * DELTA CDUZ
                EXTEND
                MP              M22                     # DELTAQ = M21*(DEL CDUY) + M22*(DEL CDUZ)
                DAS             ITEMP2                  # DOUBLE PRECISION Q-BODY-ANGLE INCREMENT
                EXTEND
                DCA		ITEMP2
                EXTEND
                DV		Q			# RESCALE TO PI/64
# FINALLY, DERIVE Q AND R BODY ANGULAR RATES:

                EXTEND                                  # WFORQR IS K/(NOMINAL DT) SCALED AT 16
                MP              WFORQR                  # FORM WEIGHTED VALUE OF MEASURED DATA
                XCH             OMEGAQ                  # SAVE AND BEGIN TO WEIGHT VALUE OF OLD W
                EXTEND                                  # (1-K) IS SCALED AT 1 FOR EFFICIENT CALC
                MP              (1-K)                   # (K CHANGES EVERY 2 SECS IN ASCENT)
                AD              JETRATEQ                # WEIGHTED TERM DUE TO JET ACCELERATION
                AD              AOSQTERM                # TERM DUE TO ASCENT OFFSET ACCELERATION
                ADS             OMEGAQ                  # TOTAL RATE ESTIMATE SCALED AT PI/4

                CAE             ITEMP3                  # GET DELTAR
                EXTEND                                  # WFORQR IS K/(NOMINAL DT) SCALED AT 16
                MP              WFORQR                  # FORM WEIGHTED VALUE OF MEASURED DATA
                XCH             OMEGAR                  # SAVE AND BEGIN TO WEIGHT VALUE OF OLD W
                EXTEND                                  # (1-K) IS SCALED AT 1 FOR EFFICIENT CALC
                MP              (1-K)                   # (K CHANGES EVERY 2 SECS IN ASCENT)
                AD              JETRATER                # WEIGHTED TERM DUE TO JET ACCELERATION
                AD              AOSRTERM                # TERM DUE TO ASCENT OFFSET ACCELERATION
                ADS             OMEGAR                  # TOTAL RATE ESTIMATE SCALED AT PI/4

## Page 521
                TC              QJUMPADR
SKIPQRAX        CA              NORMQADR
                TS              QJUMPADR		# DO NOT JUMP NEXT TIME.
                TCF		CHKGIMBL		# CHKGIMBL ATTEMPTS TO USE GTS.
                
NORMQADR	GENADR		NORMALQ
NORMALQ		TCF		ATTSTEER		# NO RHC INPUTS IN 206.

# START CODING FOR MODULE 3 REMAKE, AUGUST 1967***START CODING FOR MODULE 3 REMAKE, AUGUST 1967*****************

TRMCHECK	DXCH		T5AD6			# SET UP NEXT T5RUPT ADDRESS.

# **END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****************

# CHECK IF TRIMCNTR HAS BEEN COUNTED DOWN TO ZERO, INDICATING THAT 20.0 SECONDS HAVE PASSED SINCE DPS ON AND
# CONTROL SHOULD BE TRANSFERRED TO GTS.  THEN SEE IF A RECENT ENGINE-ON REQUIRES AN EARLY GTS ENTRY.

		CCS		TRIMCNTR		# IS GTS NEEDED PRIOR TO THROTTLE-UP?
		TCF		CHKMNITR		#   NOT YET, BUT CHECK IF FIRST GTS DONE.
		TC		CCSHOLE			#   ILLEGAL VALUE OF TRIMCNTR.
		TCF		INSERT17	+1	#   NOT ACTIVE, RETURN TO RCS CONTROL
OKAYGTS		CAF		USEQRJTS		#   YES, IS GIMBAL SYSTEM USABLE?
		MASK		DAPBOOLS
		EXTEND
		BZF		GOGIMBAL		# USABLE.  GO TO GTS.
		TCF		INSERT17	+1	# NOT USABLE.  GO ON WITH RCS CONTROL.
		
CHKMNITR	CCS		GTSMNITR		# IS AN IMMEDIATE (FIRST) GTS CALLED FOR?
		TCF		OKAYGTS			#   YES, CHECK IF GIMBAL SYSTEM USABLE.
		TCF		INSERT17	+1	#   NO, RETURN TO RCS CONTROL.
GOGIMBAL	CS		THREE			# RESET TIME5 COUTNER FROM 20 TO 50 MSEC.
		ADS		TIME5
		
		CS		BTIM24			# TURN OFF GIMBALS FOR BETTER FILTERING.
		EXTEND
		WAND		12
		
		CS		BIT1			# DEACTIVATE GIMBAL DRIVE TIMERS
		TS		QGIMTIMR
		TS		RGIMTIMR
		
		CAF		ZERO
		EXTEND
		WRITE		5			# TURN OFF ALL Q,R AXIS JETS.
		
		EXTEND
		DCA		ADRGOGTS
		DTCB
		EBANK=		DT
ADRGOGTS	2CADR		GOTOGTS		+2	# TIME5 COUNTER WAS ALREADY ADVANCED.

# *** THE FOLLOWING NEW CODING IS NOT BEING USED   ***
## Page 522
# LEFT IN PLACE AS FILLER)))MAY BE WRITTEN OVER
	
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		TCS		CCSHOLE			# FILLER
		EBANK=		NEGUR
RGIMADR		2CADR		OFFGTMR

GETCNTR		CAE		FORCFTRM		# LOAD TRIMCNTR TO FORCE TRIM JUST BEFORE
		TS		TRIMCNTR		# THE THROTTLE-UP.
		CAF		BIT1			# ENABLE MONITOR TO CALL GTS AS SOON AS
		TS		GTSMNITR		# POSSIBLE.
		
		CAE		SIMPINIT		# INITIALIZE SIMPCNTR. DECISECONDS.
		TS		SIMPCNTR
		
		EXTEND					# RETURN TO ORIGINAL CODING
		DCA		INSRTADR
		DTCB
		
		TC		CCSHOLE			# THIS IS A FILLER
		EBANK=		PERROR
INSRTADR	2CADR		INSERT20	+1

17INSRT		CS		/TEMP1/			# COMPARE Q WITH THE GENADR OF SWRETURN
		AD		SWRETADR		# TO SEE IF ENGINOFF WAS CALLED VIA
		EXTEND					# BANKCALL OR IBNKCALL.
		BZF		17INSRTB		# *BANKCALL - DO NOT DELAY*
		
		EXTEND					# *IBNKCALL - CHECK FURTHER*
		READ		30
		COM					# SEE IF ENGINE IN QUESTION IS APS OR DPS.
		MASK		BIT2
		EXTEND
		BZR		17INSRTB		# *DPS ENGINE - DO NOT DELAY*
		
		CS		MODREG			# *APS ENGINE - CHECK FURTHER*
		AD		MP3MMODE
		EXTEND					# SEE IF THIS IS THE MP 3 SHORT APS BURN.
		BZF		17INSRTB		# *IT IS - DO NOT DELAY*
		
		CS		DVMNEXIT		# *IT IS NOT - CHECK FOR A FORGET2 ENTRY*
		AD		KILLAVEG
		EXTEND
## Page 523
		BZF		17INSRTD		# GENADRS MATCH - CHECK THE BBCONS.
		
17INSRTE	EXTEND
		DCS		/TEMP3/
		DXCH		RUPTREG3		# PUT MINUS (ENGINEON TIME) IN RUPTREGS
		DXCH		/TEMP5/			# AND SAVE FORMER CONTENTS FOR ISWRETRN.
		
		EXTEND					# BLEND IN THE CURRENT TIME.
		DCA		TIME2
		DAS		RUPTREG3
		
		CAF		HALF			# FORCE SIGN AGREEMENT.
		DOUBLE
		AD		RUPTREG4
		TS		RUPTREG4
		CAF		ZERO
		AD		NEGONE
		ADS		RUPTREG3
		
		CA		RUPTREG3		# SEE IF BURN HAS BEEN LONGER THAN
		EXTEND					# 163.84 SECONDS.
		BZF		17INSRTC		# *LESS THAN 163.84 SECONDS*
		
17INSRTA	EXTEND					# *MORE THAN 163.84 SECONDS*
		DCA		/TEMP5/
		DXCH		RUPTREG3		# RESTORE RUPTREGS FOR ISWRETRN.

17INSRTF	CAF		NEGMAX			# SET TMINAPS NEGATIVE TO INACTIVATE
		TS		TMINAPS			# THE ENGINOFF DELAY LOGIC
		
17INSRTB	CA		/TEMP2/			# RESTORE CALLERS EBANK.
		TS		EBANK
		TC		POSTJUMP		# RETURN TO THE ENGINOFF SEQUENCE.
		CADR		ENGINOFF	+1
		
17INSRTC	CS		RUPTREG4		# CHECK LENGTH OF BURN AGAINST TMINAPS.
		AD		TMINAPS
		EXTEND
		BRMF		17INSRTA		# BURN IS LONG ENOUTH - DO THE ENGINOFF.
		
		TC		WAITLIST		# SUSPEND CURRENT MISSION PHASE AND SET
		EBANK=		TMINAPS			# WAITLIST FOR RESUMPTION AT THE PROPER
		2CADR		17INSRTA		# TIME.
		
		TC		TASKOVER
		
17INSRTD	CS		DVMNEXIT	+1
		AD		KILLAVEG	+1
		EXTEND
		BZF		17INSRTF		# BBCONS MATCH - DO NOT DELAY
## Page 524
		TCF		17INSRTE
		
SWRETADR	GENADR		SWRETURN

MP3MMODE	OCT		00071			# MAJOR MODE OF MISSION PHASE 3.

		EBANK=		LST1
KILLAVEG	2CADR		AVEGKILL

# FOLLOWING CODING LEFT IN PLACE TO KEEP ADDRESSES CONSTANT.

# **END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****************

NOQJETS         TC		CCSHOLE			# LABEL PREVENTS ASSEMBLER CUSSES.
                TCF             XTRANS
                TCF             R-,CHKDB
                TCF             XTRANS

NEGQEROR        AD              -RATEDB
                EXTEND
                BZMF            NOQJETS

                CCS             RRATEDIF
                TCF             R+Q-CHKR
                TCF             Q-NORJTS
                TCF             R-Q-CHKR

Q-NORJTS        CS              QRATEDIF
                TS              RATEDIF
                AD              -2JETLIM
                EXTEND
                BZMF            2JETS+Q
                TCF             4JETS+Q

R+Q-CHKR        AD              -RATEDB
                EXTEND
                BZMF            Q-NORJTS
                TC              EDOTVGEN
                TCF             2-V.RATE

R-Q-CHKR        AD              -RATEDB
                EXTEND
                BZMF            Q-NORJTS
                TC              EDOTUGEN
                EXTEND
                SU              RRATEDIF
                TCF             2+U.RATE

POSQEROR        AD              -RATEDB
                EXTEND
## Page 525
                BZMF            NOQJETS

                CCS             RRATEDIF
                TCF             R+Q+CHKR
                TCF             Q+NORJTS
                TCF             R-Q+CHKR

Q+NORJTS        CA              QRATEDIF
                TS              RATEDIF
                AD              -2JETLIM
                EXTEND
                BZMF            2JETS-Q
                TCF             4JETS-Q

R+Q+CHKR        AD              -RATEDB
                EXTEND
                BZMF            Q+NORJTS
                TC              EDOTUGEN
                TCF             2-U.RATE

R-Q+CHKR        AD              -RATEDB
                EXTEND
                BZMF            Q+NORJTS
                TC              EDOTVGEN
                TCF             2+V.RATE

R+,CHKDB        AD              -RATEDB
                EXTEND
                BZMF            XTRANS
                CA              RRATEDIF
                TS              RATEDIF
                AD              -2JETLIM
                EXTEND
                BZMF            2JETS-R
                TCF             4JETS-R

R-,CHKDB        AD              -RATEDB
                EXTEND
                BZMF            XTRANS
                CS              RRATEDIF
                TS              RATEDIF
                AD              -2JETLIM
                EXTEND
                BZMF            2JETS+R
                TCF             4JETS+R

RTJETIME        CCS             RATEDIF                 # SCALED AT PI/4 RADIANS/SECOND
                AD              ONE
                TCF             +2
                AD              ONE                     # ABS(RATEDIF)
## Page 526
                EXTEND
                MP              1/NJETAC                # SCALED AT 2(8)/PI SECONDS(2)/RADIANS
                EXTEND
                MP              BIT4                    # SCALED AT 2(3) SECONDS
                CAE             L
                EXTEND
                MP              25/32.QR                # TJET NOW PROPERLY SCALED IN A
                TS              TQR                     # AT 2(4)16/25 SECONDS
                TCF             MNIMPTST


## Page 527
# DAP SECTION: XTRANS            MOD. NO. 3  DATE: JANUARY 6, 1967.

# AUTHOR: JOHN S. BLISS (ADAMS ASSOCIATES)

# MODIFICATION BY: JONATHAN D. ADDELSTON (ADAMS ASSOCIATES)

# X-AXIS TRANSLATION LOGIC (IN THE ABSENSE OF Q,R-AXIS ROTATION) IS INITIATED IN THE "XTRANS" SECTION.

# XTRANS FIRST SETS ADDTLT6 AND ADDT6JTS TO ZERO FOR USE BY "JTLST" AND "T6JOB" WHEN THEY ARE CALLED.  IT THEN
# CHECKS FOR PLUS OR MINUS X TRANSLATION REQUESTS FROM THE ASTRONAUT'S STICK.  IF NONE IS REQUESTED IN THAT WAY,
# THE ULLAGE BIT OF DAPBOOLS IS CHECKED.  (NOTE THAT THE ORDER OF THE TESTS ALLOWS THE ASTRONAUT TO OVERRIDE THE
# INTERNAL ULLAGE REQUEST.)  IF NO TRANSLATION IS REQUESTED, ALL Q,R-AXIS JETS ARE TURNED OFF AND THE INTERRUPT
# IS TERMINATED.

# CALLING SEQUENCE: NONE          SUBROUTINES CALLED: WRITEQR

# NORMAL EXIT: 1.  IF NO TRANSLATION, RESUME.
#	       2.  IF TRANSLATION OR ULLAGE, +/-XTRAN

# ALARM/ABORT MODE: NONE.

# INPUT:  ULLAGER/DAPBOOLS,BITS7,8/CHANNEL 31.

# OUTPUT: C(ANYTRANS) = NEGMAX FOR +X TRANSLATION.
#	  C(ANYTRANS) = POSMAX FOR -X TRANSLATION.
#	  C(TRANSNOW) = C(TRANSAVE) = +0.
#	  C(TRANONLY) = PNZ
# C(ADDTLT6), C(ADDT6JTS), C(TQR), C(TOFJTCHG) = 0.

#         C(CHANNEL 5) = 0 IF NO X-TRANSLATION REQUESTED

# DEBRIS: A, L, Q


XTRANS          CAF             ZERO			# PICK UP ZERO AND INITIALIZE
                TS              ADDTLT6
                TS              ADDT6JTS
                TS		TOFJTCHG
                TS		TQR			# A ZERO OF JET TIME FOR THE TORQUE VECTOR
                
                CAF		BIT7			# IS PLUS X TRANSLATION DESIRED
                EXTEND
                RAND		31			# CHANNEL 31 BITS INVERTED
                EXTEND
                BZF		+XORULGE		# YES, +X
                
                CAF		BIT8			# NO, IS MINUS X TRANSLATION DESIRED
                EXTEND
                RAND		31			# CHANNEL 31 BITS INVERTED
## Page 528
		EXTEND
		BZF		-XTRANS			# NO, IS ULLAGE(+X TRANSLATION) DESIRED
		MASK		DAPBOOLS
		CCS		A
		TCF		+XORULGE		# YES, ULLAGE
		
		CAF		ZERO			# SINCE NEITHER ROTATION NOR TRANSLATION
		TC		WRITEQR			# ARE NEEDED, TURN OFF ALL Q,R-AXES JETS.
		TCF		RESUME
		
+XORULGE	CAF		NEGMAX			# PLUS TRANSLATION OR ULLAGE DESIRED:
		TCF		+2			# LOAD NEGMAX IN A AND SKIP NEXT OPCODE TO
		
-XTRANS         CAF		POSMAX			# -X TRANSLATION DESIRED, A = POSMAX, AND
		TS		ANYTRANS		# LOAD ANYTRANS WITH A(NEG/POS MAX)
		
		CAF		ZERO			# INITIALIZE TRANSNOW AND TRANSAVE WITH
		TS		TRANSNOW		# ZERO FOR USE IN THE JET POLICY SELECTION
		TS		TRANSAVE		# PROGRAM.
		
		EXTEND					# SET UP 2CADR FOR TRANSFER TO +/-XTRAN.
		DCA		JTPOLADR	
		TS		TRANONLY		# STORE POSITIVE, NON-ZERO S-REGISTER IN
		DTCB					# TRANONLY.  AFTER +/-XTRAN, GO TO JTLST.
		
		EBANK=		JTSONNOW
JTPOLADR	2CADR		+/-XTRAN		# TRANSLATION ONLY ENTRY TO JET POLICY


## Page 529
# ALL Q,R AXES TQR COMPUTATIONS TERMINATE IN THIS PROGRAM WHICH PERFORMS A SERIES OF TESTS TO DETERMINE THE TRUE
#   TIME THE JETS SHOULD BE ON. THESE TESTS ARE AS FOLLOWS ...

#      1.  TEST THE ON TIME AGAINST THE 7.5 MS  ELECTRICAL COMMAND (MIN).IF THE ON TIME IS LESS THAN THE MINIMUM
#          WE BUG OUT TO XTRAN,WHERE X TRANSLATION IS DONE(IF NEEDED).

#      2.  TEST THE ON TIME AGAINST 150 MS, IF TQR IS GREATER THAN 150MS ,THEN THE NEXT QR AXIS IS DONE IN 100 MS.
#          IF TQR IS LESS THAN 150 MS, THEN THE NEXT QR AXIS IS DONE IN 200 MS. THAT IS A QR AXIS SKIP IS DONE.

#      3.  WHEN TQR IS LESS THAN 150 MS  THE PROGRAM GOES TO THE JET LIST PROGRAM WHERE THE T6 CLOCK IS SET UP.

#      4.  BEFORE GOING TO THE JET LIST THE COMPUTED TIME HAS EITHER 7.5 MS  ADDED OR 5MS  SUBTRACTED-THE EXACT
#	   OPERATION BEING DECIDED BY WHETHER THE JETS WHICH ARE TO GO ON ARE OFF OR ARE ON RESPECTIVELY.

#      5.  IF SOME OF THE JETS WHICH ARE TO GO ON ARE NOW ON AND SOME ARE OFF, THEN A ******* COMPUTATION CALLED
#	   NOTRANS DECIDES WHICH JETS GO OFF AT TQR AND WHICH GO OFF AT TQR+6.5MS. THIS 6.5 MS. IS STORED IN
#	   ADDTLT6. ADDTLT6 IS SET TO ZERO OTHERWISE.

NORMRETN	TS		TQR


MNIMPTST	CS		TQR			# TEST FOR TQR GREATER THAN MIN. IMPULSE.
		AD		+T6TJMIN
		EXTEND					#   CORRECT BRANCH.
		BZMF		TQRGTTMI		# BRANCH FOR TQR = OR GREATER THAN MINIMP.
		TCF		XTRANS			# SEE IF TRANSLATION IS DESIRED .
TQRGTTMI	CAE		TQR			# HERE JETS ON FOR LONGER THAN GRUMANN
		TS		TOFJTCHG		# MINIMUM IMPULSE SPECIFICATIONS.
		AD		-1.5CSP
		EXTEND
		BZMF		DOQRSKIP
		CAE		JTSONNOW
		TC		WRITEQR
		TCF		RESUME
		
SKIPQRAD	GENADR		SIPQRAX
# CHANGE JET ON AND OFF BITS TO ACCOUNT FOR THE PRESENT STATE OF THE
#   CHANNEL. THE CHANGES ACCOUNT FOR PURE ROTATION ONLY- NOT TRANSLATION.
DOQRSKIP	CA		JTSONNOW
		EXTEND
		RAND		5			# MASK THE CHANNEL WITH THE DESIRED STATE.
FROMROOT	EXTEND					# ENTER HERE FROM DORUTDUM (IN K.E. BANK)
		BZF		NOQRON			# A IS ZERO IF NO JETS TO GO ON ARE ON.
		AD		BIT15			# MAKE DIFFERENCE CORRESPOND TO A QR JET.
		EXTEND
		SU		JTSONNOW		# RESULT IS COMPLEMENT OF JET BITS WHICH
		TS		L			#   ARE TO BE ON FOR 6.5MS MORE THAN CALC.
		EXTEND
		BZF		JTSAREON		# A=0,THUS ALL JETS TO GO ON ARE NOW ON.
## Page 530
TRSLTMN2        CAE             JTSATCHG
                MASK            POSMAX                  # REMOVE BIT15 FROM JSATCHG
                EXTEND
                BZF             NOTRANS                 # IF JFSTACHG = 0 THEN NO TRANSLATION NOW.
                CA              14-TQRMN
                ADS             TOFJTCHG                # INSURE T GREATER THAN 14 MS.
                TCF             TOJTLST
NOTRANS         CS              L
                AD              BIT15                   # MAKE JET BITS CORRESPOND TO QR AXIS.
                XCH             JTSATCHG                # JTSONNOW - L = JETS ON AT TOFJTCHG.
                TS              ADDT6JTS                # JTS ON AT TOFJTCHG +ONDELAY.
                CA              14-TQRMN
                TS              ADDTLT6
                TCF             TOJTLST
NOQRON          CA              14-TQRMN
                ADS             TOFJTCHG
                TCF             TOJTLST		-2
JTSAREON        CAE		JTSATCHG
		MASK		POSMAX
		EXTEND
		TCF		TOJTLST 	-2
		CAF             MCOMPTQR
                ADS             TOFJTCHG
                EXTEND					# TEST FOR COMPUTATION OF NEGATIVE OR ZERO
                BZMF		QUICKOFF		# TOFJTCHG, IF SO, MAKE -0.
 -2             CAF             ZERO
                TS              ADDTLT6
TOJTLST         CA		SKIPQRAD
		TS		QJUMPADR
		CAE             JTSONNOW		# TURN ON JETS TO GO ON NOW (EVEN IF ALL
                TC              WRITEQR			# ARE ALREADY ON), AFTER TESTING FOR RISE.
                EXTEND
                DCA             JTLSTADR
                DTCB
                
QUICKOFF	CS		TOFJTCHG		# SET TOFJTCHG TO -0 IN SHORTEST WAY.
		TCF		NOQRON		+1
                
-1.5CSP         DEC             -0.01465
+T6TJMIN        DEC             +.00073
25/32.QR        DEC             0.78125
MS20QR          OCTAL           37776
MS30QR          OCTAL           37775
MS50QR          OCTAL           37773
16/32400        DEC             0.00049
BIT8,9          OCTAL           00600
MCOMPTQR        OCTAL           -16                     # -10 MS COMPUATAION TIME
14-TQRMN        DEC             11
# START CODING FOR MODULE 3 REMAKE, AUGUST 1967***START CODING FOR MODULE 3 REMAKE, AUGUST 1967*********************
## Page 531
MINTADR         GENADR          MINTJET
# **END CODING FOR MODULE 3 REMAKE, AUGUST 1967*****END CODING FOR MODULE 3 REMAKE, AUGUST 1967*********************
-.88975         DEC             -.88975
(1-K),QR        DEC             0.50000                 # K = 1/2
(1-KQ)/8        DEC             0.06250
-90MS           DEC             -.00879
+90MS           DEC             0.00879
NEGCSP2         DEC             -.00977
ALL+XJTS        OCTAL           40252
2,10-OUT        OCTAL           00201
+X,A            OCTAL           40042
+X,B            OCTAL           40210
1,9-OUT         OCTAL           00104
-X,A            OCTAL           40104
-X,B            OCTAL           40021
		EBANK=		JTSONNOW
JTLSTADR        2CADR           JTLST

RTJETADR        GENADR          RTJETIME


## Page 532
# Q,R-AXES ATTITUDE STEERING CALCULATIONS:

# (EXECUTED WHEN LGC IS IN AUTOMATIC SCSMODE OR IF SCSMODE IS ATTITUDE HOLD AND THE ROTATIONAL HAND CONTROLLER IS
# NEITHER OUT OF DETENT NOR IS THE RATE COMMAND BIT SET IN DAPBOOLS)

CHKGIMBL	EXTEND
		DCA		TRYGTSAD		# TRYGTS ATTEMPTS GTS CONTROL
		DXCH		Z
		TC		CCSHOLE
		
BGIM24		OCTAL		07400
DESCADR		GENADR		TJETLAW

		EBANK=		DT
TRYGTSAD	2CADR		TRYGTS			# TRYGTS ATTEMPS GTS CONTROL.


## Page 533
# "ATTSTEER" IS THE NOMINAL ENTRY POINT FOR THE REACTION CONTROL SYSTEM ATTITUDE STEERING

ATTSTEER	EQUALS		QERRCALC
QERRCALC	CAE		CDUY			# Q-ERROR CALCULATION
		EXTEND
		MSU		CDUYD			# CDU ANGLE - ANGLE DESIRED (Y-AXIS)
		TS		ITEMP1			# SAVE FOR RERRCALC
		EXTEND
		MP		M21			# (CDUY-CDUYD)*M21 SCALED AT PI RADIANS
		XCH		ER			# SAVE FIRST TERM (OF TWO) IN OPP.AXIS REG
		CAE		CDUZ			# SECOND TERM CALCULATION:
		EXTEND
		MSU		CDUZD			# CDU ANGLE -ANGLE DESIRED (Z-AXIS)
		TS		ITEMP2			# SAVE FOR RERRCALC
		EXTEND
		MP		M22			# (CDUZ-CDUZD)*M22 SCALED AT PI RADIANS
		ADS		ER			# SAVE SUM OF TERMS, NO OVERFLOW EVER
		TS		QERROR			# SAVE QERROR FOR EIGHT-BALL DISPLAY
		
RERRCALC        CAE             ITEMP1                  # R-ERROR CALCULATION:
                EXTEND                                  # CDU ANGLE -ANGLE DESIRED (Y-AXIS)
                MP              M31                     # (CDUY-CDUYD)*M31 SCALED AT PI RADIANS
                XCH             E                       # SAVE FIRST TERM (OF TWO) IN OPP.AXIS REG
                CAE             ITEMP2                  # SECOND TERM CALCULATION:
                EXTEND                                  # CDU ANGLE -ANGLE DESIRED (Z-AXIS)
                MP              M32                     # (CDUZ-CDUZD)*M32 SCALED AT PI RADIANS
                ADS             E                       # SAVE SUM OF TERMS, NO OVERFLOW EVER
                TS              RERROR                  # SAVE R-ERROR FOR EIGHT-BALL DISPLAY

		TCF		STILLRCS

# THIS CODING IS ENTERED FROM BURGZERO, WHEN BOTH URGENCIES ARE ZERO.  EXITS TO GTS IF POSSIBLE, XTRANS OTHERWISE

GIMBLTRY	CAF		USEQRJTS		# IS JET USAGE MANDATORY.
		MASK		DAPBOOLS
		CCS		A
		TCF		XTRANS			# YES.  GO TO XTRANS.
		
		EXTEND					# ARE GIMBALS DRIVING?
		READ		12
		MASK		BGIM24			# BITS 9,10,11,12 ARE GIMBAL DRIVE BITS.
		CCS		A
		TCF		XTRANS			# YES.  DRIVING.  GO TO XTRANS.
		
		EXTEND					# NO.   CHECK JETS.
		READ		5			# ARE ANY Q,R JETS ON NOW.
							# (CAN ONLY BE ROTATION JETS.)
		EXTEND
		BZF		XTRANS			# NO.   GO TO XTRANS.
		
## Page 534
		CAF		ZERO			# YES.  TURN ON JETS.
		EXTEND
		WRITE		5
		
		EXTEND					# NO.   GO TO GTS.
		DCA		GOGTSADR
		DXCH		Z
		
		EBANK=		DT
GOGTSADR	2CADR		GOTOGTS

# REMAINING CODING (HERE TO STILLRCS) STAYS IN TO KEEP ADDRESSES CONSTANT.

		TC		CCSHOLE			# FILLER.
		TCF		STILLRCS		# NO.      SO USE RCS.
		INDEX		QRCNTR			# YES.     TRY THE ERROR MAGNITUDE.
		CCS		QDIFF			# IS ERROR SMALL ENOUGH FOR GTS.
		AD		-XBND+1			# -1.4 DEG SCALED AT PI    + 1 BIT
		TCF		+2
		AD		-XBND+1
		EXTEND
		BZMF		+2			# IS ERROR LESS,EQUAL 1.4 DEG.
		TCF		STILLRCS		# NO.      USE RCS CONTROL.
		CCS		QRCNTR			# THIS AXIS IS FINE.   ARE BOTH DONE.
		TC		CCSHOLE			# REMOVE REFERENCE TO ELIMINATED SYMBOL.
		TC		CCSHOLE			# FILLER.
-RATLM+1	OCT		77512			# -.5 DEG/SEC SCALED AT PI/4  + 1 BIT
-XBND+1		OCT		77601			# -1.4 DEG SCALED AT PI, + 1 BIT.
# "STILLRCS" IS THE ENTRY POINT TO RCS ATTITUDE STERRING WHENEVER IT IS FOUND THAT THE TRIM GIMBAL CONTROL
# SYSTEM SHOULD NOT BE USED;

## Page 535
# Q,R-AXES RCS URGENCY FUNCTION LOGIC:

STILLRCS	CCS		DAPBOOLS		# BRANCH TO SPS-BACKUP RCS CONTROL LOGIC.
		TCF		SPSBAKUP		# WHEN BIT15/DAPBOOLS = 0.
		NOOP
		CAF		DESCADR			# SET JET SELECT LOGIC RETURN ADDRESS TO
		TS		TJETADR			# Q,R-AXIS TJETLAW CALCULATION
		
		TC		T6JOBCHK		# CHECK T6 CLOCK RUPT BEFORE SUBROUTINE
		
# CALCULATE THE RATE ERRORS SCALED AT PI/4 RADIANS/SECOND(2):

		CS		OMEGAQD
		AD		OMEGAQ			# EDOTQ = OMEGAQ - OMEGAQD
		TS		EDOTQ
		
		CS		OMEGARD
		AD		OMEGAR			# EDOTR = OMEGAR - OMEGARD
		TS		EDOTR
		
## Page 536
# Q,R-AXES URGENCY FUNCTION LOOP:

# SET UP LOOP TO DO R-AXIS, THEN Q-AXIS:

		CAF		ONE			# 1: REFERS TO R-AXIS VARIABLES.
		TS		AXISCNTR		# 0: REFERS TO Q-AXIS VARIABLES.
		
# PICK UP EDOT AND RESCALE FROM PI/4 TO PI/16 RADIANS/SECOND:

URGLOOP		INDEX		AXISCNTR		# ERROR RATES ARE PRE-CALCULATED BY RATE
		CAE		EDOTQ			# DERIVATION SCALED AT PI/4 RADIANS/SECOND
		EXTEND					# MULTIPLYING BY FOUR (BIT3) LEAVES EDOT
		MP		FOUR			# AS C(L) IF EDOT LESS THAN 11.25 DEG/SEC.
		EXTEND
		BZF		+2			# IF C(A) NON-ZERO, THEN EDOT GREATER THAN
		TCF		EDOTMAX			# 11.25 DEG/SEC IN MAGNITUDE, SO LIMIT IT.
		
		CCS		L			# INSURE NON-ZERO EDOT:
		AD		TWO			# C(L) PNZ REMAINS UNCHANGED.
		TCF		+2			# C(L) NNZ REMAINS UNCHANGED.
		COM					# C(L)  +0 BECOMES 77776.
		AD		NEG1			# C(L)  -0 BECOMES 77776.
EDOTSTOR	TS		EDOT			# SAVE NON-ZERO EDOT SCALED AT PI/16.

		EXTEND					# CALCULATE (EDOT)(EDOT):
		SQUARE
		TS		EDOT(2)			# SCALED AT PI(2)/2(+8) RAD(2)/SEC(2).
		
		EXTEND					#  0.5               +8       2
		INDEX		AXISCNTR		# ------  SCALED AT 2  /PI SEC /RAD.
		MP		1/ACCQ			# ACCQ,R
		EXTEND					# DEADBAND = 5.0 OR 1.0 OR 0.3 DEGREES
		SU		DB			# SCALED AT PI RADIANS.
		TS		FPQR			# 0.5(1/ACC)EDOT(2)-DB SCALED AT PI RADS.
		
		CAE		EDOT(2)			# SCALED AT PI(2)/2(8) RAD(2)/SEC(2).
		EXTEND
		INDEX		AXISCNTR
		MP		1/AMINQ			# .5(1/ACCMIN) AT 2(8)/PI SEC(2)/RAD.
		AD		DB			# DEADBAND SCALED AT PI RADIANS.
		TS		FPQRMIN			# .5(1/ACCMIN)EDOT(2)+DB SCALED AT PI RAD.
		
		CCS		EDOT			# EDOT TEST ON SIGN (NON-ZERO):
		CAE		E			# ATTITUDE ERROR FOR THIS AXIS
		TCF		+2			# SCALED AT PI RADIANS.
		TCF		EDOTNEG
		ADS		FPQR			# E+0.5(1/ACC)EDOT(2)-DB SCALED AT PI RAD.
		
FTEST		CCS		EDOT			# EDOT GUARANTEED NOT +0 OR -0.
		CCS		FPQR			# FPQR GUARANTEED NOT +0.
## Page 537
		TCF		QUICKURG		# EDOT.G.+0, FPQR.G.+0.
		CCS		FPQR			# EDOT.L.-0.
		TCF		FMINCALC		# EDOT.L.-0,FPQR.G.+0/EDOT.G.+0,FPQR.L.-0.
		TCF		FMINCALC		# EDOT.G.+0,FPQR.E.-0 (FROM FIRST CCS).
		TCF		QUICKURG		# EDOT.L.-0,FPQR.L.-0.
		
QUICKURG	CAE		EDOT			# EDOT.L.-0,FPQR.E.-0 (FROM 2ND CCS).
		EXTEND					# SCALE FROM PI/16 TO PI RADIANS/SECOND
		MP		BIT11			# TO HAVE SAME SCALING AS FPQR AFTER THE
		AD		FPQR			# IMPLICIT MULT. OF FPQR BY 1/SEC.
		TCF		URGMULT			# THIS URGENCY = (1/ACC)(FPQR+EDOT).
		
EDOTMAX		CCS		A			# GURANTEED NOT +0 OR -0.
		CAF		POSMAX
		TCF		EDOTSTORE		# SET EDOT TO SIGNED MAXIMUM.
		CS		POSMAX
		TCF		EDOTSTOR		# SCALED AT PI/16 RADIANS/SECOND.
		
EDOTNEG		CS		FPQR			# SCALED AT PI RADIANS
		AD		E			# ATTITUDE ERROR FOR THIS AXIS
		TS		FPQR			# E-0.5(1/ACC)EDOT(2)+DB SCALED AT PI RAD.
		TCF		FTEST
		
FMINCALC	CCS		FPQR			# NECESSARY RETEST ON FPQR;
		CS		FPQRMIN
		TCF		+2			# E-0.5(1/ACCMIN)EDOT(2)-DB
		CAE		FPQRMIN
		AD		E			# E+0.5(1/ACCMIN)EDOT(2)+DB
		TS		FPQRMIN			# SCALED AT PI RADIANS.
		
		CCS		EDOT			# EDOT    GUARANTEED NOT +0 OR -0.
		CCS		FPQRMIN			# FPQRMIN GUARANTEED NOT +0 (CALL IT F).
		TCF		ZEROURG			# EDOT.G.+0, F.G.+0.
		CCS		FPQRMIN			# EDOT.L.-0.
		TCF		NORMURG			# EDOT.L.-0, F.G.+0 / EDOT.G.+0, F.L.-0.
		TCF		NORMURG			# EDOT.G.+0, F.E.-0 (FROM FIRST CCS).
		TCF		ZEROURG			# EDOT.L.-0, F.L.-0.
ZEROURG		EXTEND					# EDOT.L.-0, F.E.-0 (FROM 2ND CCS).
		DCA		DPZEROY			# THIS URGENCY IS ZERO.
		DXCH		URGENCYQ
		TCF		MOREURG			# TEST FOR NEXT AXIS
		
NORMURG		CAE		FPQRMIN			# THIS URGENCY IS FPQRMIN(1/ACC).
URGMULT		EXTEND
		INDEX		AXISCNTR
		MP		1/ACCQ
		DXCH		URGENCYQ		# SAVE D.P. SCALED AT 2(+9).
		
MOREURG		CCS		AXISCNTR		# TEST FOR END OF LOOP
		TCF		+2			# CONTINUE.
		
## Page 538



# DO NECESSARY PARTS OF Q,R-AXES TORQUE VECTOR RECONSTRUCTION HERE AND NOW.  FOR OTHER PARTS WAIT UNTIL THE NEXT
# P-AXIS RCS DAP T5RUPT.

TORQUEV         CS              TQR                     # CALCULATED Q,R JET TIME (AS IN TIME6)
                AD              +T6TJMIN
                EXTEND                                  #   CORRECT BRANCH.
                BZMF            TQRGTTMI                # BRANCH FOR TQR = OR GREATER THAN MINIMP.
                CA              ZERO
                TS              TOFJTCHG                # SINCE TQR LESS THAN A MINIMUM IMPULSE,
                TS              JETRATEQ                #   ZERO ALL OF THESE REGISTERS AND GO TO
                TS              JETRATER                #   JET LIST.
                CA              JTSATCHG
                TC              WRITEQR
                TCF             RESUME
TQRGTTMI        CA              TQR
                TS              TOFJTCHG
                AD              -1.5CSP
                EXTEND
                BZMF            DOQRSKIP
                CA              1JACCQ
                EXTEND
                MP              NO.QJETS
                CA              L
                TS              ITEMP1
                EXTEND
                MP              QR.1STOQ
## Note: in the scan the two statements above (EXTEND, MP QR.1STOQ) are boxed in (red) and a marked with a question mark
##     I.E.   ----------------------------
##            | EXTEND                   |
##            | MP              QR.1STOQ |   ?
##            ----------------------------
                TS              JETRATEQ
                CA              ITEMP1
                EXTEND
                MP              0.1AT1
                ADS             SUMRATEQ
                CA              1JACCR
                EXTEND
                MP              NO.RJETS
                CA              L
                TS              ITEMP1
                EXTEND
                MP              QR.1STOQ
## Note: in the scan the two statements above (EXTEND, MP QR.1STOQ) are boxed in (red) and a marked with a question mark
##       See above.
                TS              JETRATER
                CA              ITEMP1
                EXTEND
                MP              0.1AT1
                ADS             SUMRATER
                CA              JTSONNOW
                TCF             WRITEON
SKIPQRAD        GENADR          SKIPQRAX
0.1AT1          DEC             +0.10000
DOQRSKIP        CA              SKIPQRAD
                TS              QJUMPADR
# CHANGE JET ON AND OFF BITS TO ACCOUNT FOR PRESENT STATE OF THE

## Page 572
# CHANNEL. THE CHANGES ACCOUNT FOR PURE ROTATON ONLY- NOT TRANSLATION.
                CA              JTSONNOW                # = JETS WHICH ARE TO GO ON NOW.
                EXTEND
                RAND            5                       # MASK THE CHANNEL WITH THE DESIRED STATE.
                EXTEND
                BZF             NOQRON                  # A IS ZERO IF NO JETS TO GO ON ARE ON.
                AD              BIT15                   # MAKE DIFFERENCE CORRESPOND TO A QR JET.
                EXTEND
                SU              JTSONNOW                # RESULT IS COMPLEMENT OF JET BITS WHICH
                TS              L                       #   ARE TO BE ON FOR 6.5MS MORE THAN CALC.
                EXTEND
                BZF             JTSAREON                # A=0,THUS AL JETS TO GO ON ARE NOW ON.

## Page 574
# Q,R-AXES ATTITUDE STEERING CALCULATIONS:

# (EXECUTED WHEN LGC IS IN AUTOMATIC SCSMODE OR IF SCSMODE IS ATTITUDE HOLD AND THE ROTATIONAL HAND CONTROLLER IS
# NEITHER OUT OF DETENT NOR IS THE RATE COMMAND BIT SET IN DAPBOOLS)

# IMMEDIATELY AFTER CALCULATING THE ATTITUDE ERRORS, THE FOLLOWING TESTS ARE MADE TO DETERMINE WHETHER THE DESCENT
# ENGINE TRIM GIMBAL SHOULD BE USED TO CONTROL THE LEM ATTITUDE RATHER THAN TEH RCS JETS:

#          1) IS THE TRIM GIMBAL FUNCTIONALLY OPERATIVE?
#          2) ARE THE Q,R-AXES RCS JETS OFF?
#          3) ARE BOTH TRIM GIMBAL DRIVES OFF?
#          4) IS THE LEM RATE LESS THAN .5 DEG/SEC ABOUT BOTH AXES?

GOTOGTS         CAF             INITFILT                # ERRORS NOW CONTROLLABLE BY TRIM GIMBAL
                TS              T5ADR                   # SET T5RUPT TO GO TO FILTER INITIALIZING
                TCF             RESUME                  # PROGRAM

BGIM24          OCTAL           07400
DESCADR         GENADR          TJET-LAW                # RETURN ADDRESS FOR JET SELECT LOGIC
INITFILT        GENADR          FILTINIT                # ADDRESS OF FILTER INITIALIZATION RUPT

# "ATTSTEER" IS THE NOMINAL ENTRY POINT FOR REACTION CONTROL SYSTEM ATTITUDE STEERING:
# BEGIN ATTSTEER BY CHECKING IF RATE HOLD MODE(CURRENTLY USED ONLY AT SIVB
# -LEM SEPARATION-206 MISSION PHASE 6) IS REQUESTED(BIT 14 OF DAPBOOLS ON)
# IF BIT 14 IS OFF, BRANCH TO QERRCALC DIRECTLY AND BEGIN AUTOMATIC
# STEERING.  IF BIT 14 IS ON, TEST BIT 3 OF DAPBOOLS TO SEE IF THE DESIRED
# RATE HAS BEEN SAVED YET.  IF IT IS ON, THIS IS NOT THE FIRST PASS AND
# THE RATE HAS BEEN SAVED.  GO DIRECTLY TO QERRCALC FOR AUTOMATIC STEERING
# IF THE BIT IS OFF, THE RATE MUST BE SAVED.  TRANSFER TO SAVERATE(BANK25)
# AND RETURN AFTER FIRST PASS TO RESUME AND DAPIDLER.

# IN ORDER TO USE RATE HOLD, THE MISSION PROGRAMMER MUST SET BIT 14 OF
# DAPBOOLS ON AND SET BIT 3 OF DAPBOOLS TO ZERO.  UPON RETURNING FROM THE
# FIRST PASS AT LEAST THROUGH RATE HOLD, THE MISSION PROGRAMMER MUST RESET
# BIT 3 TO ITS PREVIOUS VALUE IF THIS IS NOT 1, BECASUE SAVERATE SETS BIT3
# TO 1 FOR ALL PASSES AFTER THE FIRST IN ORDER NOT TO SAVE THE RATE AGAIN.

# IN ADDITION TO NON-RATE HOLD MODE AND NON-FIRST PASS RATE HOLD MODE
# EXITS TO QERRCALC, THE FIRST PASS EXITS TO RESUME, IE. OUT OF INTERRUPT
# AND BACK TO DAPIDLER TO AWAIT THE NEXT CALL TO DAP.

# RATE HOLD PRODUCES THE FOLLOWING OUTPUT IN ERASABLE --

#    CDUD - SCALED AT +/-PI, DESIRED GIMBAL ANGLE

#    DELCDU - SCALED AT +/-PI, INCREMENT TO CDUD EVERY 100 MS.

#    OMEGAPD, QD, RD - SCALED AT +/-PI/4, BODY AXIS RATES

# ALL THESE ARE USED BY AUTOMATIC STEERING MODE EQUATIONS.

## Page 575
# RATE HOLD REQUIRES OMEGAP, Q, R EVERY .25 SEC, AND ALSO REQUIRES PILOT-
# TO-GIMBAL AXIS MATRIX ELEMENTS, MR12, 22, 13, 23 TO BE LOCATED IN THAT
# ORDER.

# FINALLY, RATE HOLD LEAVES DEBRIS IN --

#    DLCDUIDX - LOOP INDEX USED IN COMPUTING DELCDUS, = 1, 0

#    ITEMP1 - STORES TEMPORARY PRODUCTS AND SUMS, LEFT WITH DELCDUY IN 1S.



ATTSTEER        CS              DAPBOOLS                # DOES BIT14 OF DAPBOOLS REQUEST RATE HOLD
                MASK            BIT14                   # (SIVB-LEM SEPARATION)
                CCS             A
                TCF             QERRCALC                # NO, GO DIRECTLY TO AUTOMATIC STEERING

# CHECK DAPBOOLS, BIT3, TO SEE IF DESIRED RATE HAS BEEN SAVED YET

                CAE             DAPBOOLS                # DOES BIT3 SHOW THAT THE DESIRED RATE HAS
                MASK            BIT3                    # BEEN SAVED(NOT FIRST PASS).  IF NOT, GO
                CCS             A                       # SAVE DESIRED RATES IN OMEGADS
                TCF             NEXDLCDU        -1      # YES, COMPUTE THE DELCDUS.

# SAVERATE IS ENTERED ONLY DURING THE FIRST PASS THROUGH RATE HOLD.  IT
# SAVES THE CURRENT CDUS FIRST IN CDUDS AND THEN SAVES THE BODY RATES,
# OMEGAP, Q, R IN OMEGAPD, QD, RD.  NEXT, WE SET BIT 3 OF DAPBOOLS TO 1.

SAVERATE        EXTEND                                  # COME HERE FIRST TIME INTO RATE HOLD IN
                DCA             CDUY
                DXCH            CDUYD                   # ORDER TO SET UP RATES, CDUS, AND DELCDUS
                CAE             CDUX
                TS              CDUXD                   # FIRST, CDUDS = CDUS AT SIVB SEPARATION

                EXTEND                                  # NEXT, SAVE CURRENT SIVB SEPARATION RATES
                DCA             OMEGAP
                DXCH            OMEGAPD                 # OMEGAP AND OMEGAR, IN OMEGAPD AND
                CAE             OMEGAR
                TS              OMEGARD                 # OMEGARD.  LEM HELD TO RATES FOR 13 SECS.

                CAF             BIT3                    # RESET BIT 3 = 1 SO THAT RATES NOT SAVED
                ADS             DAPBOOLS                # AGAIN IN RATE HOLD PASSES
                TCF             RESUME                  # RETURN TO IDLE AFTER SAVING RATE

100MSCAL        DEC             .025                    # 100 MS. SACLED AT 4 SEC.  RATE HOLD DELT

# TO COMPUTE TEH DELCDUS, Y AND Z, WE SET UP A LOOP AND SOLVE THE EQUATION

# C(DELCDUY+DLCDUIDX)=(OMEGAQD.C(MR12+DLCDUIDX)+OMEGARD.C(MR13+DLCDUIDX))
#                       .(100MS) SCALED AT PI IN 2S COMPLEMENT(LIKE CDUS)

## Page 576
# DURING THIS COMPUTATION, ITEMP1 IS USED TO STORE THE PARTIAL SUMS AND
# PRODUCTS.  DELCDUY IS RESCALED TO 1 AS MR12 AND MR13 ARE SCALED AT 2.
# AFTER CONVERTING TO TWOS COMPLEMENT, WE SET DELCDUX TO ZERO TO AVOID ANY
# ROLL DURING RATE HOLD MODE.  NOTE THAT DELCDUS ARE COMPUTED IN THE NEGA-
# TIVE TO ALLOW 2S COMP. MOD. SUBTRACT LATER ON (CDU-(-DELCDU))

                CAF             ONE                     # SET UP LOOP INDEX TO COMPUTE DELCDUS.
NEXDLCDU        TS              DLCDUIDX                # DLCDUIDX = C(A)

                CS              OMEGAQD                 # DLCDUIDX = 1              DLCDUIDX = 0
                EXTEND                                  # ITEMP1=-OMEGAQD.MR22
                INDEX           DLCDUIDX
                MP              MR12                    # MR22 SCALED AT 1       MR12 SCALED AT 2
                TS              ITEMP1                  #                     ITEMP1=-OMEGAQD.MR12

                CS              OMEGARD                 # C(A)=ITEMP1 -OMEGARD.MR23
                EXTEND
                INDEX           DLCDUIDX                #                C(A)=ITEMP1 -OMEGARD.MR13
                MP              MR13                    # MR23 SCALED AT 1        MR13 SCALED AT 2
                AD              ITEMP1
                EXTEND                                  # DELT = 100 MS. SCALED AT 4 SEC.
                MP              100MSCAL
                TS              ITEMP1                  # ITEMP1 = C(A) . DELT

                CCS             DLCDUIDX                # CHECK INDEX FOR RESCALING
                TCF             +3                      # DELCDUZ SCALED AT PI/4, RESCALE UNNEEDED
                CAE             ITEMP1                  # DELCDUY SCALED AT PI/2, RESCALE BY
                ADS             ITEMP1                  # ADDING TO ITSELF

                CCS             ITEMP1                  # CONVERT DELCDUS TO TWOS COMPLEMENT (SAME
                AD              ONE                     # AS CDUS).  ADD ONE TO RESTORE PRE-CCS A
                TCF             STODLCDU                # STORE DIRECT IF POSITIVE ZERO
                COM                                     # COMPLEMENT IF NEGATIVE, CCS INCREMENTS
STODLCDU        INDEX           DLCDUIDX                # IF NEGATIVE ZERO, STORE POSTIVE ZERO
                TS              DELCDUY                 # STORE FINAL DELCDUZ OR DELCDUY

                CCS             DLCDUIDX                # TEST INDEX DLCDUIDX, EITHER 1 OR 0
                TCF             NEXDLCDU                # IF 1, DO DELCDUY
                TS              DELCDUX                 # DELCDUZ,Y DONE, 0 TO DELCDUX-NO ROLL

QERRCALC        CAE             CDUY                    # Q-ERROR CALCULATION
                EXTEND
                MSU             CDUYD                   # CDU ANGLE - ANGLE DESIRED (Y-AXIS)
                TS              ITEMP1                  # SAVE FOR RERRCALC
                EXTEND
                MP              M21                     # (CDUY-CDUYD)*M21 SCALED AT PI RADIANS
                XCH             ER                      # SAVE FIRST TERM (OF TWO) IN OPP.AXIS REG
                CAE             CDUZ                    # SECOND TERM CALCULATION:
                EXTEND
                MSU             CDUZD                   # CDU ANGLE -ANGLE DESIRED (Z-AXIS)

## Page 577
                TS              ITEMP2                  # SAVE FOR RERRCALC
                EXTEND
                MP              M22                     # (CDUZ-CDUZD)*M22 SCALED AT PI RADIANS
                ADS             ER                      # SAVE SUM OF TERMS, NO OVERFLOW EVER
                TS              QERROR                  # SAVE QERROR FOR EIGHT-BALL DISPLAY

# TEST (1): IS THE TRIM GIMBAL FUNCTIONALLY OPERATIVE?

                CAF             BIT2                    # TEST TO SEE IF LEM AND DAP MODES ALLOW
                MASK            DAPBOOLS                # USE OF TRIM GIMBAL CONTROL SYSTEM:
                CCS             A                       # BIT2 = 0 MEANS THAT TRIM GIMBAL CONTROL
                TCF             STILLRCS                # IS POSSIBLE, SO TEST OTHER TG CONDITIONS

# TEST (2): ARE THE Q,R-AXES RCS JETS OFF?
                EXTEND                                  # BUT, IF JETS ARE OFF AND TRIM GIMBAL MAY
                READ            5                       # POSSIBLY BE USED: BEING IN THE JET COAST
                CCS             A                       # REGION OF THE PHASE PLANE IS A NECESSARY
                TCF             STILLRCS                # BUT INSUFFICIENT REASON FOR GTS USE

# TEST (3): ARE BOTH TRIM GIMBAL DRIVES OFF?

                EXTEND                                  # BITS 9-12 OF CHANNEL 12 ARE THE SIGNALS
                READ            12                      # WHICH DRIVE THE TRIM GIMBAL ENGINE:
                MASK            BGIM24                  # IF NONE OF THESE BITS ARE ON, THEN BOTH
                CCS             A                       # WAITLIST TASKS TO TURN OFF THE DRIVES
                TCF             STILLRCS                # HAVE BEEN DONE AND GTS CONTROL CAN OCCUR

# TEST (4): IS THE LEM RATE LESS THAN .5 DEG/SEC ABOUT BOTH AXES?

                CA              BIT1
LOOPTOP         TS              QRCNTR
                DOUBLE
                INDEX           A
                CCS             OMEGAQ                  # IS ERROR RATE SMALL ENOUGH FOR GTS.
                AD              -RATLM+1                # -.5 DEG/SEC SCALED AT PI/4 + 1 BIT
                TCF             +2
                AD              -RATLM+1
                EXTEND
                BZMF            +2                      # IS RATE LESS,EQUAL .5 DEG/SEC.
                TCF             STILLRCS                # NO.      SO USE RCS.

## Page 578
                INDEX           QRCNTR                  # YES.     TRY THE ERROR MAGNITUDE.
                CCS             QDIFF                   # IS ERROR SMALL ENOUGH FOR GTS.
                AD              -XBND+1                 # -1.4 DEG SCALED AT PI    + 1 BIT
                TCF             +2
                AD              -XBND+1
                EXTEND
                BZMF            +2                      # IS ERROR LESS,EQUAL 1.4 DEG.
                TCF             STILLRCS                # NO.      USE RCS CONTROL.
                CCS             QRCNTR                  # THIS AXIS IS FINE.   ARE BOTH DONE.
                TCF             LOOPTOP                 # NOW TRY THE Q AXIS.
                TCF             GOTOGTS                 # TRANSFER TO TRIM GIMBAL CONTROL
-RATLM+1        OCT             77512                   # -.5 DEG/SEC SCALED AT PI/4  + 1 BIT.
-XBND+1         OCT             77601                   # -1.4 DEG SCALED AT PI. + 1 BIT.
# "STILLRCS" IS THE ENTRY POINT TO RCS ATTITUDE STEERING WHENEVER IT IS FOUND THAT THE TRIM GIMBAL CONTROL
# SYSTEM SHOULD NOT BE USED:

STILLRCS        CAF             DESCADR                 # SET JET SELECT LOGIC RETURN ADDRESS TO
                TS              TJETADR                 # SET Q,R-AXIS TJETLAW CALCULATION

                TC              T6JOBCHK                # CHECK T6 CLOCK RUPT BEFORE SUBROUTINE

RURGENCY        CAE             1/NJTSR                 # SET-UP URGENCY SUBROUTINE
                TS              1/NJETAC
## Note: Target  (See below)
                CS              OMEGARD                 # EDOTR = OMEGAR - OMEGARD
                AD              OMEGAR
                TS              EDOTR                   # SCALED AT PI/4 RADIANS
                TC              URGROUTN                # *** SUBROUTINE CALL ***
                TS              URGENCYR                # URGENCY LEFT IN A SCALED AT 2(4) SECS

                DXCH            E                       # MOVE R-AXIS VARIABLES TO R-AXIS ERASABLE
                DXCH            ER                      # FROM Q-XIS (COMMON) ERASABLE
                TS              E
                CAE             EDOT                    # (LLOK AT REORG FOR EFFIC: JDA 7/17/66)
                TS              EDOT(R)

QURGENCY        CAE             1/NJTSQ                 # SET-UP URGENCY SUBROUTINE
                TS              1/NJETAC
                CS              OMEGAQD                 # EDOTQ = OMEGAQ - OMEGAQD
                AD              OMEGAQ
                TS              EDOTQ                   # SCALED AT PI/4 RADIANS
                TC              URGROUTN                # *** SUBROUTINE CALL ***

                TS              URGENCYQ                # URGENCY LEFT IN A SCALED AT 2(4) SECS
## Note: in the scan the statements starting with QURGENCY are marked with red side bars
##       and a red box. The box has the marker CAE EDOTQ and an arrow pointing
##       in between the two statements marked as 'Target' above.
##
##                       ...
##                 TS             1/NJETAC
##                                        <------|
##                 CS             OMEGARD        |
##                                               |
##                       ...                     |
##                                               |
##  QURGENCY     | CAE             1/NJTSQ   |   |
##               | TS              1/NJETAC  |   |
##               |---------------------------|   |
##               | CS              OMEGAQD   |   |
##  CAE          | AD              OMEGAQ    |---|
##     EDOTQ     | TS              EDOTQ     |
##               |---------------------------|
##               | TC              URGROUTN  |
##               | TS              URGENCYQ  |
##

                EXTEND
                BZF             BURGZERO                # TEST FOR BOTH URGENCIES ZERO

                EXTEND
                MP              -TAN22.5
                AD              URGENCYR
                EXTEND

## Page 579
                MP              COS22.5
                TS              TERMA                   # UR.COS(22.5)-UQ.SIN(22.5)

                CS              URGENCYR
                EXTEND
                MP              -TAN22.5
                AD              URGENCYQ
                EXTEND
                MP              COS22.5
                TS              TERMB                   # UR.SIN(22.5)+UQ.COS(22.5)

A+B/A-B         AD              TERMA
                TS              A+B
A-B/ONLY        CS              TERMB
                AD              TERMA
                TS              A-B

# AXIS AND MODE SELECTION

                CAE             TERMB                   # B URGENCY TEST
                EXTEND
                BZMF            NEGBURG

POSBURG         CAE             TERMA                   # A URGENCY TEST
                EXTEND
                BZMF            NEGAPOSB

POSAPOSB        CA              A-B
                EXTEND
                BZMF            MINUSU                  # NEGATIVE U-AXIS SELECTED

2/4JET-R        EXTEND
                DCA             ER
                DXCH            E
                CAE             EDOT(R)
                TS              EDOT
                CAE             .5ACCMNR
                TS              .5ACCMNE
                CAF             URM                     # 2/4 JET URGENCY TEST -R AXIS
                AD              URGENCYR
                EXTEND
                BZMF            2JETS-R

4JETS-R         CAE             1/2JTSR                 # MOVE 1/NJETAC UNMODIFIED
                TS              1/NJETAC
                CS              SEVEN
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS-R         CCS             RMANDACC                # ASCENT 4-JET OVER-RIDE TEST
                TCF             4JETS-R

## Page 580
                CAE             1/2JTSR
                TS              1/NJETAC
                CS              SIX
                TCF             POLTYPE                 # GO FIND BEST POLICY

MINUSU          CAE             .5ACCMNU
                TS              .5ACCMNE
                CAE             URGENCYQ                # 2 JET OPT/MAND TEST: -U AXIS
                AD              URGENCYR
                CCS             A
                AD              NEGURGUM
                TCF             +2
                AD              NEGURGUM
                EXTEND
                BZMF            2JETS-U

2JETSM-U        TC              UXFORM
2-U.RATE        CS              FIVE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS-U         CCS             UMANDACC                # ASCENT 2-JET MANDATORY OVER-RIDE TEST
                TCF             2JETSM-U
                TC              UXFORM
                CS              FOUR
                TCF             POLTYPE                 # GO FIND BEST POLICY

NEGAPOSB        CAE             A+B
                EXTEND
                BZMF            PLUSV

2/4JET-Q        CAE             .5ACCMNQ
                TS              .5ACCMNE
                CAF             UQM                     # 204 JET URGENCY TEST: -Q AXIS
                AD              URGENCYQ
                EXTEND
                BZMF            2JETS-Q         +2      # (FIRST TWO INSTRUCTIONS UNNECESSARY)

4JETS-Q         CAE             1/2JTSQ                 # MOVE 1/NJETAC UNMODIFIED
                TS              1/NJETAC
                CS              THREE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS-Q         CCS             QMANDACC                # ASCENT 4-JET OVER-RIDE TEST
                TCF             4JETS-Q
                CAE             1/2JTSQ
                TS              1/NJETAC
                CS              TWO
                TCF             POLTYPE                 # GO FIND BEST POLICY

PLUSV           CAE             .5ACCMNV

## Page 581
                TS              .5ACCMNE
                CS              URGENCYQ                # 2 JET OPT/MAND TEST" +V AXIS
                AD              URGENCYR
                CCS             A
                AD              NEGURGVM
                TCF             +2
                AD              NEGURGVM
                EXTEND
                BZMF            2JETS+V

2JETSM+V        TC              VXFORM
2+V.RATE        CS              ONE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS+V         CCS             VMANDACC                # ASCENT 2-JET MANDATORY OVER-RIDE TEST
                TCF             2JETSM+V
                TC              VXFORM
                CAF             ZERO
                TCF             POLTYPE                 # GO FIND BEST POLICY

BURGZERO        CAE             URGENCYR                # TEST FOR SECOND URGENCY ALSO ZERO
                EXTEND
                BZF             XTRANS                  # NO ROTATION NEEDED NOW

                EXTEND                                  # TIME SAVING A+B CALCULATION
                MP              SIN22.5
                TS              TERMB                   # US.SIN(22.5)
                CAE             URGENCYR
                EXTEND
                MP              COS22.5
                TS              TERMA                   # UR.COS(22.5)
                TCF             A-B/ONLY
COS22.5         DEC             0.92388                 # COSINE OF 22.5 DEGREES
SIN22.5         DEC             0.38268                 # SINE OF 22.5 DEGREES
-TAN22.5        DEC             -.41421                 # NEGATIVE OF TANGENT OF 22.5 DEGREES

NEGBURG         CAE             TERMA                   # A URGENCY TEST
                EXTEND
                BZMF            NEGANEGB

POSANEGB        CAE             A+B
                EXTEND
                BZMF            2/4JET+Q

MINUSV          CAE             .5ACCMNV
                TS              .5ACCMNE
                CS              URGENCYQ                # 2 JET OPT/MAND TEST: -V AXIS
                AD              URGENCYR
                CCS             A
                AD              NEGURGVM

## Page 582
                TCF             +2
                AD              NEGURGVM
                EXTEND
                BZMF            2JETS-V

2JETSM-V        TC              VXFORM
2-V.RATE        CAF             ONE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS-V         CCS             VMANDACC                # ASCENT 2-JET MANDATORY OVER-RIDE TEST
                TCF             2JETSM-V
                TC              VXFORM
                CAF             TWO
                TCF             POLTYPE                 # GO FIND BEST POLICY

NEGANEGB        CAE             A-B
                EXTEND
                BZMF            2/4JET+R

PLUSU           CAE             .5ACCMNU
                TS              .5ACCMNE
                CAE             URGENCYQ                # 2 JET OPT/MAND TEST: +U AXIS
                AD              URGENCYR
                CCS             A
                AD              NEGURGUM
                TCF             +2
                AD              NEGURGUM
                EXTEND
                BZMF            2JETS+U

2JETSM+U        TC              UXFORM
2+U.RATE        CAF             THREE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS+U         CCS             UMANDACC                # ASCENT 2-JET MANADTORY OVER-RIDE TEST
                TCF             2JETSM+U
                TC              UXFORM
                CAF             FOUR
                TCF             POLTYPE                 # GO FIND BEST POLICY

2/4JET+R        EXTEND
                DCA             ER
                DXCH            E
                CAE             EDOT(R)
                TS              EDOT
                CAE             .5ACCMNR
                TS              .5ACCMNE
                CAF             URM                     # 2/4 JET URGENCY TETS +R AXIS
                AD              URGENCYR
                EXTEND

## Page 583
                BZMF            2JETS+R

4JETS+R         CAE             1/2JTSR                 # MOVE 1/NJETAC UNMODIFIED
                TS              1/NJETAC
                CAF             FIVE
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS+R         CCS             RMANDACC                # ASCENT 4-JET OVER-RIDE TEST
                TCF             4JETS+R
                CAE             1/2JTSR
                TS              1/NJETAC
                CAF             SIX
                TCF             POLTYPE                 # GO FIND BEST POLICY

2/4JET+Q        CAE             .5ACCMNQ
                TS              .5ACCMNE
                CAF             UQM                     # 2/4 JET URGENCY TEST: + Q AXIS
                AD              URGENCYQ
                EXTEND
                BZMF            2JETS+Q         +2      # (FIRST TWO INSTRUCTIONS UNNECESSARY)

4JETS+Q         CAE             1/2JTSQ                 # MOVE 1/NJETAC UNMODIFIED
                TS              1/NJETAC
                CAF             SEVEN
                TCF             POLTYPE                 # GO FIND BEST POLICY

2JETS+Q         CCS             QMANDACC                # ASCENT 4-JET OVER-RIDE TEST
                TCF             4JETS+Q
                CAE             1/2JTSQ
                TS              1/NJETAC
                CAF             EIGHT

POLTYPE         TS              POLRELOC
                EXTEND
                DCA             POLADR
                DTCB
POLADR          2CADR           POLTYPEP

## Page 584
# SUBROUTINES UXFORM AND VXFORM CALCULATE NEEDED VALUES FOR T-JET LAW
# (THEY GO OFF TO REDUCE RATE, IF NECESSARY, AND THEN DO NOT RETURN)

VXFORM          CAE             1/2JETSV                # GET INVERSE OF V-JET ACCELERATION
                TS              1/NJETAC
                CS              EQ                      # COMPLEMENT FOR TRANSFORMATION
                TS              EQ
                CS              EDOTQ
                TCF             UVXFORM         +1
UXFORM          CAE             1/2JETSU                # SET INVERSE OF U-JET ACCELERATION
                TS              1/NJETAC

UVXFORM         CAE             EDOTQ                   # TRANSFORM ANGULAR RATE TO U/V-AXIS
                AD              EDOTR
                EXTEND
                MP              .707
                TS              EDOT                    # SAVE FOR REDUCEUV
                EXTEND
                MP              BIT3
                EXTEND
                BZF             +2                      # CHECK FOR VALUE BEYOND SCALING RANGE
                TCF             REDUCEQR                # SAME AS REDUCEUV
                CAE             L
                TS              EDOT                    # SAVE RATE SCALED AT PI/16
                EXTEND
                SQUARE
                TS              EDOT(2)                 # SAVE RATE SQUARED SCALED AT PI(2)/2(8)

                CAE             EQ                      # TRANSFORM ANGULAR ERROR TO U/V-AXIS
                AD              ER
                EXTEND
                MP              .707
                TS              E                       # SAVE ERROR SCALED AT PI
                TC              Q

.707            DEC             0.70711                 # SQRT(1/2)



NEGURGUM        DEC             -.18750
NEGURGVM        EQUALS          NEGURGUM
UQM             EQUALS          NEGURGUM
URM             EQUALS          NEGURGUM


## Page 585
# GENERALIZED URGENCY SUBROUTINE FOR USE ON ALL PILOT AXES (P,Q,R)...

# DEPENDING ON THE AXIS PROBLEM, EDOTP,EDOTQ,EDOTR IS EXPECTED TO ARRIVE IN A AND 1/2JTSP,1/2JTSQ,1/2JTSR IN
# 1/NJETAC.  NOTE THAT THE Q,R-AXIS PROBLEM IS EXPECTED TO DO THE R-AXIS PROBLEM FIRST (FOR EFFICIENT USE OF
# ERASABLE) AND THE Q,R-AXIS PROBLEM DOES NOT USE TPSIG.
# (THIS ROUTINE SHOULD BE IN THE FIXED BANK OF THE Q,R-AXIS PROBLEM SINCE IT IS CALLED ONLY ONCE FROM THE P-AXIS.)

URGROUTN        TS              EDOT                    # SAVE FOR REDUCER
                EXTEND                                  # EXPECT EDOT IN A SCALED AT PI/4 RAD/SEC
                MP              BIT3                    # TRY TO RESCALE TO PI/16 RADIANS/SECOND
                EXTEND
                BZF             +2                      # OVERFLOW CHECK ON NEW SCALING
                TCF             REDUCERA                # DISTINGUISH BETWEEN P AND Q,R
 +2             CCS             L                       # INSURE NON-ZERO EDOT (TPSIG FLAG)
                AD              TWO
                TCF             +2
                COM
 +2             AD              NEG1
                TS              TPSIG                   # (FOR P-AXIS PROBLEM ONLY)
                TS              EDOT                    # SAVE FOR T-JET LAW SCALED AT PI/16

                EXTEND
                SQUARE
                TS              EDOT(2)                 # SCALED AT PI(2)/2(8) RAD(2)/SEC(2)

                EXTEND                                  # 1/2JTSP,1/2JTSQ,1/2JTSR IN 1/NJETAC
                MP              1/NJETAC                # SCALED AT 2(8)/PI SEC(2)/RAD
                EXTEND
                SU              DB                      # DEADBAND SCALED AT PI RADIANS
                TS              FPQR                    # .5(1/ACC)EDOT(2) - DB SCALED AT PI RADS

                CAE             EDOT(2)                 # SCALED AT PI(2)/2(8) RAD(2)/SEC(2)
                EXTEND
                MP              .5ACCMNE                # .5(1/ACCMIN) AT 2(8)/PI SEC(2)/RAD
                AD              DB                      # SCALED AT PI RADIANS
                TS              FPQRMIN                 # .5(1/ACCMIN)EDOT(2) + DB AT PI RADIANS

                CCS             EDOT                    # EDOT TEST ON SIGN
                CAE             E                       # P,Q,R-AXIS ERROR SCALED AT PI RADIANS
                TCF             +2
                TCF             EDOTNEG
 +2             ADS             FPQR                    # E + .5(1/ACC)EDOT(2) - DB AT PI RADIANS

FTEST           CCS             EDOT                    # EDOT GUARANTEED NOT +0 OR -0
                CCS             FPQR                    # FPQR GUARANTEED NOT +0
                TCF             TPSIGCHG                # EDOT.G.+0, FPQR.G.+0
                CCS             FPQR                    # EDOT.L.-0
                TCF             FPMINCAL                # EDOT.L.-0,FPQR.G.+0/EDOT.G.+0,FPQR.L.-0
                TCF             FPMINCAL                # EDOT.G.+0, FPQR.E.-0 (FROM FIRST CCS)
                TCF             TPSIGCHG                # EDOT.L.-0, FPQR.L.-0

## Page 586
TPSIGCHG        CS              TPSIG                   # EDOT.L.-0, FPQR.E.-0 (FROM 2ND CSS)
                TS              TPSIG                   # (SIGN OF P-AXIS JETS IF NEEDED)
                CAE             EDOT                    # SCALED AT PI/16 RADIANS/SECOND
                EXTEND
                MP              BIT11                   # SCALE TO PI RADIANS/SECOND
                AD              FPQR                    # (IMPLICIT MULT OF FPQR BY 1/SEC)
                TCF             URGMULT                 # THIS URGENCY = (1/ACC)(FPQR+EDOT)

EDOTNEG         CS              FPQR                    # SCALED AT PI RADIANS
                AD              E
                TS              FPQR                    # E - .5(1/ACC)EDOT(2) + DB
                TCF             FTEST

FPMINCAL        CCS             FPQR                    # NECESSARY RETEST ON FPQR
                CS              FPQRMIN
                TCF             +2                      # E - .5(1/ACCMIN)EDOT(2) - DB
                CAE             FPQRMIN
                AD              E                       # E + .5(1/ACCMIN)EDOT(2) + DB
                TS              FPQRMIN                 # (SCALED AT PI RADIANS)

                CCS             EDOT                    # EDOT    GUARANTEED NOT +0 OR -0
                CCS             FPQRMIN                 # FPQRMIN GUARANTEED NOT +0 (CALL IT F)
                TCF             ZEROURG                 # EDOT.G.+0, F.G.+0
                CCS             FPQRMIN                 # EDOT.L.-0
                TCF             NORMURG                 # EDOT.L.-0, F.G.+0 / EDOT.G.+0, F.L.-0
                TCF             NORMURG                 # EDOT.G.+0, F.E.-0 (FROM FIRST CCS)
                TCF             ZEROURG                 # EDOT.L.-0, F.L.-0
ZEROURG         CAF             ZERO                    # EDOT.L.-0, F.E.-0 (FROM SECOND CCS)
                TCF             URGSTORE                # THIS URGENCY ZERO (IN COAST REGIAN)

NORMURG         CAE             FPQRMIN                 # THIS URGENCY FPQRMIN(1/ACC)
URGMULT         EXTEND
                MP              1/NJETAC
                EXTEND                                  # SCALE FROM 2(9) TO 2(4) SECONDS
                MP              BIT6                    # 1/NJETAC = 1/2JETAC, WANT 1/1JETAC
                EXTEND
                BZF             URGTOA
                CCS             A
                CA              POSMAX
                TCF             URGSTORE
                CS              POSMAX
                TCF             URGSTORE
URGTOA          CA              L
URGSTORE        TC              Q                       # *** RETURN ***

## Page 587
# GENERALIZED T-JET LAW SUBROUTINE FOR USE BY BOTH THE P-AXIS AND THE Q,R-AXIS PROBLEMS (ONCE EACH)...

# DEPENDING ON THE AXIS ABOUT WHICH ROTATION IS DEEMED MOST URGETN, 1/JACC FOR THAT AXIS IS EPXECTED IN 1/NJETAC
# AND THE CORRESPONDING VALUES FOR E, EDOT, AND EDOT(2) ARE ALSO EXPECTED TO BE SET UP IN ADVANCE.
# (THIS ROUTINE MAY RESIDE IN THE FIXED BANK OF EITHER THE P-AXIS OR Q,R-AXIS PROBLEM.)

# ***** IMPORTANT NOTICE *****

#     NOTE THAT TJETLOC IS THE LOCAL ENTRY POINT FOR THIS PROGRAM AND TJETLAW IS THE CROSS-BANK ENTRY.  SEE BELOW
# FOR THE TWO CALLING SEQUENCES FOR OPTIMAL USE AND BE ASSURED THAT FOR EITHER CASE ISWRETRN MUST BE USED AND
# RUPTREG3 CONTAINS THE EVENTUAL RETURN ADDRESS.

# LOCAL CALL:
#          TC     TJETLOC
#          TCF    NO ROTATION JETS
#          TS     TIME CALCULATED

# CROSS-BANK CALL:
#          CAF    TJETLAWCADR
#          TC     ISWCALL
#          TCF    NO ROTATION JETS
#          TS     TIME CALCULATED



# ***** VERY IMPORTANT NOTICE *****

# SINCE THE Q,R-AXES SWITCHED FIXED BANK BECAME VERY FULL (DUE TO THE ADDITION OF RATE-HOLD MODE AND A BETTER
# RCS-GTS INTERFACE), THE LOCAL CALL AND LOCAL ENTRY POINT FOR THE T-JET LAW HAVE BEEN DELETED AS OF REVISION  7
# OF AURORA (BY JON ADDLESTON 10/24/66).



# FOR CONVENIENCE, WE INCLUDE HERE THE CALL FROM THE Q,R-AXIS PROBLEM:

                BANK            24
QR-JETLW        CADR            TJET-LAW                # CADR OF Q,R-ENTRY TO TJETLAW SUBROUTINE

TJET-LAW        TC              T6JOBCHK                # CHECK T6 CLOCK RUPT BEFORE SUBROUTINE

                CAF             QR-JETLW                # T-JETLAW CALLING SEQUENCE (LIKE P-AXIS)
                TC              ISWCALL                 # (IN INTERBANK COMMUNICATION LOG SECTION)
                TCF             XTRANS                  # GO TO XTRANS SINCE NO ROTATION IS USED
                TS              TQR                     # SAVE CALCULATED TIME FOR THE TORQUE
                TCF             TORQUEV                 # VECTOR RECONSTRUCTION PROBLEM


## Note: the following seems to be fully assembled code injected as comment. See the VERY IMPORTANT NOTICE above .
#    24,1000   0 0006 1  TJETLOC         EXTEND                   LOCAL ENTRY FAKES CROSS-BANK IN SMALL DT

## Page 588
#    24,1001   22 076 0  QXCH            RUPTREG                  SAVE RETURN WHERE  ISWCALL DOES
#    24,1002   3 4174 1  CAF             ISWRETRN        +3       GET CADR OF RUPTREG3 FROM TC INSTRUCTION
#    24,1003   54 002 1  TS              Q                        SO TC Q GOES TO RUPTREG3 FOR RETURN

                BANK            25

TJETLAW         CS              EDOT                    # TEST EDOT SIGN
                EXTEND
                BZMF            +4
                TS              EDOT                    # SIGNS OF E AND EDOT CHANGED IF EDOT NEG
                CS              E                       # TO CONSIDER FUNCTIONS IN UPPER HALF OF
                TS              E                       # THE E,EDOT PHASE PLANE

                CAE             EDOT(2)                 # SCALED AT PI(2)/2(8) RAD(2)/SEC(2)
                EXTEND                                  # (1/NJETAC HAS BEEN SET FOR N JETS)
                MP              1/NJETAC                # SCALED AT 2(8)/PI SEC(2)/RAD
                EXTEND
                MP              BIT14                   # .5EDOT(2)/NJETACC SCALED AT PI RADIANS
                AD              E                       # SCALED AT PI RADIANS (ERROR)
                EXTEND
                SU              DB                      # SCALED AT PI RADIANS (DEADBAND)
                TS              HDAP                    # E + .5EDOT(2)/NJETACC - DB

                EXTEND
                BZMF            NEGHDAP

                CAE             EDOT                    # SCALED AT PI/16 RAD/SEC (RATE)
                EXTEND
                MP              1/NJETAC                # SCALED AT 2(8)/PI SEC(2)/RAD (ACC) (-1)
                TS              TERMA                   # SCALED AT 2(4) SEC (CNTRL SMPL PERIOD)
                AD              NEGCSP                  # EDOT/NJETACC - CSP SCALED AT 16 SECONDS

                EXTEND
                BZMF            +3

MAXTJET         CAF             BIT14                   # (1/2) IS LIKE POSMAX AT THIS SCALING
                TCF             NORMRETN                # (OVERFLOW IS THUS PREVENTED)

                CS              HDAP                    # -DBMINIMP + E + EDOT(2)/NJETACC - DB
                AD              MINIMPDB                # SCALED AT PI RADIANS
                EXTEND
                BZMF            MAINBRCH

                CAE             TERMA                   # EDOT/NJETACC - .5TJMIN SCALED AT 16 SECS
                AD              -20MS                   # - 20 MS SCALED AT 16.
                EXTEND
                BZMF            TJMIN

                AD              23.75MS                 # WE GET TERMA + 3.75 MS.
                TCF             TJETSCAL

## Page 589
TJMIN           CS              PAXCALL                 # WE KNOW WE DO P AXIS SINCE WE HAVE RUPT-
                AD              RUPTREG3                #  REG3 = T-JETLAW +3(Q-AXIS CALL NOT AT
                EXTEND                                  #  SAME LOCATION-- WE HOPE - AND INSURE.).
                BZF             WEDOP
                CAE             NO.QJETS                # NO. OF Q JETS ON
                EXTEND
                BZF             WEDOR
                CAE             NO.RJETS                # NO. OF R JETS ON
                EXTEND
                BZF             WEDOQ
DOTJMIN         CAF             +TJMINT6
NORMRETN        INCR            RUPTREG3                # *** RETURN +1 ***
                TC              Q                       # BACK TO ISWRETRN
WEDOP           TS              OMEGAP
                TCF             DOTJMIN
WEDOR           TS              OMEGAR
                TCF             DOTJMIN
WEDOQ           TS              OMEGAQ
                TCF             DOTJMIN
PAXCALL         GENADR          T-JETLAW        +3
NEGHDAP         CAE             EDOT(2)                 # SCALED AT PI(2)/2(8) RAD(2)/SEC(2)
                EXTEND
                MP              .5ACCMNE                # .5(1/ACCMIN) AT 2(8)/PI SEC(2)/RAD
                AD              E                       # SCALED AT PI RADIANS (ERROR)
                AD              DB                      # SCALED AT PI RADIANS  (DEADBAND)
                AD              DBMINIMP
                EXTEND
                BZMF            +2
                TC              Q                       # *** RETURN *** (NO JETS)

 +2             CS              MAXRATE                 # 10 DEG/SEC SCALED AT PI/16 RAD/SEC
                AD              EDOT                    # EDOT - MAXRATE
                EXTEND
                BZMF            +2
                TC              Q                       # *** RETURN *** (NO JETS)

 +2             CS              EDOT                    # SCALED AT PI/16 RAD/SEC (RATE)
                EXTEND
                MP              1/NJETAC                # SCALED AT 2(8)/PI SEC(2)/RAD (ACC)(-1)
                TS              TERMA                   # -EDOT/NJETACC SCALED AT 2(4) SECONDS

                CS              HDAP                    # - E + .5EDOT(2)/NJETACC + DB
                AD              E
                AD              E                       # TWICE ERROR NEGATES E OF HDAP(OLD)
                AD              MINIMPDB
MAINBRCH        TS              HDAP                    # -HDAP(OLD) + 2E + DBMINIMP AT PI RADS

                CAE             1/NJETAC                # SCALED AT 2(8)/PI SEC(2)/RAD
                EXTEND
                MP              BIT14                   # (1/2)(1/NJETAC)

## Page 590
                AD              .5ACCMNE
                TS              DENOM                   # .5(1/NJETACC) + .5(1/ACCMIN) AT 2(8)/PI

                EXTEND
                MP              MAXRATE2                # SCALED AT PI(2)/2(8) RAD(2)/SEC(2)
                AD              HDAP                    # DENOM.MAXRATE(2) + HDAP AT PI RADIANS
                EXTEND
                BZMF            NOROOT

                CAE             HDAP                    # SCALED AT PI RADIANS
                EXTEND
                DV              DENOM                   # SCALED AT 2(8)/PI SEC(2)/RAD(2)
                EXTEND
                MP              1/NJETAC
                EXTEND
                MP              1/NJETAC
                TS              TERMB                   # -(HDAP/DENOM)(1/NJETACC)(2) AT 2(8) SECS

                CAF             NEGCSP                  # SCALED AT 2(4) SECONDS
                AD              TERMA
                EXTEND
                SQUARE                                  # SCALED AT 2(8) SECONDS
                AD              TERMB
                EXTEND                                  # (TERMA - CSP)(2) + TERMB
                BZMF            MAXTJET
                CAF             -TJMIN16
                AD              TERMA                   # TERMA - TJMIN SCALED AT 2(4) SECONDS
                EXTEND
                BZMF            MAYNOJET

PREROOT         EXTEND                                  # MUST SAVE Q .

                QXCH            A+B
                TC              T6JOBCHK
                CS              TERMB
                TC              SPROOT                  # SQRT(-TERMB) SCALED AT 2(4) SECONDS

                EXTEND                                  # MUST RESTORE OLD Q AFTER SPROOT
                QXCH            A+B

TJSUM           AD              TERMA                   # TERMA + SQRT(-TERMB)
TJETSCAL        DOUBLE                                  # NOW SCALED AT 2(3) SECONDS
                EXTEND
                MP              25/32QR                 # SCALED T TO 16/25 2(4) SECONDS.
                TCF             NORMRETN                # *** RETURN +1 ***

NOROOT          CAF             MAXRATE
                AD              .6DEG/SC                # MAXRATE + DEL SCALED AT PI/16 RAD/SEC
                EXTEND
                MP              1/NJETAC                # SCALED 2(8)/PI SEC(2)/RAD

## Page 591
                TCF             TJSUM                   # SCALED AT 2(4) RADIANS

MAYNOJET        CAF             -TJMIN16
                AD              TERMA                   # TERMA - TJMIN SCALED AT 2(4) SECONDS
                EXTEND
                SQUARE                                  # SCALED AT 2(8) SEC(2)
                AD              TERMB
                EXTEND
                BZMF            PREROOT                 # (TERMA - TJMIN)(2) + TERMB AT 2(8)
                TC              Q                       # *** RETURN *** (NO JETS)

NEGCSP          DEC             -.00625                 # 100 MS SCALED AT 2(4) SECONDS
+TJMINT6        DEC             +.00073
-TJMIN16        DEC             -.00047
-TJMINQR        EQUALS          -TJMIN16
23.75MS         DEC             0.00148                 # 23.75 MS SCALED AT 16 SECONDS.
-20MS           DEC             -.00125                 # - 20 MS SCALED AT 16 SECONDS.
MAXRATE         DEC             0.88889                 # 10 DEGREES/SECOND SCALED AT PI/16
MAXRATE2        DEC             0.79012                 # 100 DEG(2)/SEC(2) SCALED AT PI(2)/2(8)
.6DEG/SC        DEC             0.05333                 # 6/10 DEGREES/SECOND SACLED AT PI/16
25/32QR         DEC             0.78125

## Page 592
# THESE TWO SUBROUTINES TRANSFORM EDOTQ,EDOTR INTO THE U/V-AXIS (RESPECTIVELY) FOR THE RATE COMMAND MODE (ONLY).
# VALUE IS STORED IN EDOTGEN SCALED AT PI/4 RADIANS/SECOND.

                BANK            24

EDOTUGEN        CAE             1/2JETSU                # FOR U-AXIS TRANSFORMATION
                TS              1/NJETAC
                CAE             EDOTQ
                TCF             +4
EDOTVGEN        CAE             1/2JETSV                # FOR V-AXIS TRANSFORMATION
                TS              1/NJETAC
                CS              EDOTQ
                AD              EDOTR
                EXTEND
                MP              .707
                TS              RATEDIF
                TC              Q



# THESE PROGRAMS REDUCE THE RATE ERROR TO 10.6 DEGREES/SECOND.

REDUCERA        CS              EDOT                    # TEST FRO P-AXIS PROBLEM
                AD              EDOTP                   # EXACT MATCH MEANS P-AXIS
                EXTEND
                BZF             REDUCEP                 # P-AXIS SUM IS ALWAYS MINUS ZERO

REDUCEQR        TC              REDUCESC                # GET SHRINK FACTOR
                EXTEND                                  # SHRINK Q-AXIS COMPONENT
                MP              EDOTQ
                TS              QRATEDIF

                CAE             EDOTR                   # SHRINK R-AXIS COMPONENT
                EXTEND
                MP              EDOT
                TS              RRATEDIF

                TCF             OBEYQRRC

REDUCEP         TC              REDUCESC                # GET SHRINK FACTOR
                EXTEND                                  # SHRINK P-AXIS COMPONENT
                MP              EDOTP
                TS              EDOTP
                TS              TPSIG

                EXTEND
                DCA             +2
                DTCB
                2CADR           OBEYRAPE

## Page 593
REDUCESC        CAF             10.6D/S                 # SCALED AT PI/4
                EXTEND
                DV              EDOT                    # RESULT SCALED AT 1
                TS              EDOT                    # SAVE FACTOR IN EDOT FOR R SHRINKAGE
                TC              Q                       # *** RETURN ***

10.6D/S         DEC             0.23111                 # 10.6 DEGRESS/SECOND SCALED AT PI/4



ENDDAP24        EQUALS
